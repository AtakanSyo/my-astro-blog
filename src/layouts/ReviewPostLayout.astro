---
import Layout from './Layout.astro';
import '../styles/postsGlobal.css';
import '../styles/reviewPost.css';
import SocialShare from '../components/SocialShare.astro';

const { url } = Astro.props;

const {
  title,
  description,
  writer,
  pubDate,
  updatedDate,
  cover_image,
  rating = {}
} = Astro.props.frontmatter;

const ratingsArray = [
  { category: "Overall", value: rating.overall },
  { category: "Optics", value: rating.optics },
  { category: "Mount", value: rating.mount },
  { category: "Accessories", value: rating.accessories }
].filter(r => r.value !== undefined);

// --- NEW: condition for legacy Zane posts ---
const cutoff = new Date('2025-09-01T00:00:00Z'); // absolute date
const pubDateObj = pubDate ? new Date(pubDate) : null;
const isLegacyZane =
  (String(writer || '').trim().toLowerCase() === 'zane landers') &&
  (pubDateObj instanceof Date && !Number.isNaN(pubDateObj.getTime()) && pubDateObj < cutoff);

// What to show in the byline
const writerLine = isLegacyZane
  ? `Written by ${writer} 2 years ago, for TelescopesToBuy.`
  : `Written by ${writer}`;

const jsonLdProduct = {
  "@context": "https://schema.org",
  "@type": "Product",
  "name": title,
  "description": description,
  "review": {
    "@type": "Review",
    "author": { "@type": "Person", "name": writer },
    "datePublished": pubDate,
    "dateModified": updatedDate || pubDate,
    "reviewBody": description,
    "reviewRating": {
      "@type": "Rating",
      "ratingValue": rating.overall,
      "bestRating": "10",
      "worstRating": "1"
    }
  }
};
---

<head>
  <title>{title}</title>
  <meta name="description" content={description} />
  <script type="application/ld+json" set:html={JSON.stringify(jsonLdProduct, null, 2)}></script>
  <link rel="preload" as="image" href={cover_image} />
</head>

<Layout title={title}>

<div class="centered_flex">
<div class="review-post-starter">
  <h1>
    {title}
    {Astro.props.frontmatter.reviewType && (
      <span class={`review-tag ${Astro.props.frontmatter.reviewType}`}>
        {Astro.props.frontmatter.reviewType === "hands-on" ? "Hands-On" : "Research"}
      </span>
    )}
  </h1>
  <p class="writer">{writerLine}</p>

  <div class="review-post-starter-content">
    <div class="centered_flex">
    <img
      src={cover_image}
      class="post-starter-image"
      alt={title + ' cover'}
      fetchpriority="high"
      loading="eager"
      decoding="async"
    />
  </div>
    <div class="review-meta centered_flex">
    
      <div class="main-rating-card rating-card centered_flex">
        <span class="category">Overall</span>
        <span class="score">{rating.overall}/10</span>
      </div>
      <p class="post-starter-description">{Astro.props.frontmatter.description}</p>
      <div class="share-header"><span class="share-label">Share:</span></div>
      <SocialShare frontmatter={Astro.props.frontmatter} url={url} client:load />
    </div>
  </div>
</div>

  <article class="post review-post centered_flex">
    <slot />
  </article>

</div>
</Layout>