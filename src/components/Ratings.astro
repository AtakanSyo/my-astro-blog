---
interface RatingsMap {
  [key: string]: number | string | undefined;
}

interface Props { rating?: RatingsMap }

const { rating } = Astro.props;

function parseScore(v: number | string | undefined): number | null {
  if (v === undefined || v === null || v === '') return null;
  if (typeof v === 'number') return Math.max(0, Math.min(10, v));
  const s = String(v).trim().toLowerCase();
  const m = s.match(/^(\d+(?:\.\d+)?)(?:\s*\/\s*(\d+(?:\.\d+)?))?$/);
  if (m) {
    const num = parseFloat(m[1]);
    const den = m[2] ? parseFloat(m[2]) : 10;
    if (!isNaN(num) && !isNaN(den) && den > 0) return Math.max(0, Math.min(10, (num / den) * 10));
  }
  const map: Record<string, number> = { a: 9.5, 'a-': 9, 'b+': 8.5, b: 8, 'b-': 7.5, c: 7, 'c-': 6.5 };
  return map[s] ?? null;
}

function toLabel(key: string): string {
  return key
    .replace(/[_-]+/g, ' ')
    .replace(/\s+/g, ' ')
    .trim()
    .replace(/\b\w/g, (m) => m.toUpperCase());
}

const visible = rating
  ? Object.entries(rating)
      .map(([key, value]) => ({ key, label: toLabel(key), score: parseScore(value) }))
      .filter((c) => c.score !== null)
  : [];

function scoreDescriptor(score: number | null): string | null {
  if (score === null) return null;
  if (score >= 9) return 'cosmic';
  if (score >= 8) return 'strong pick';
  if (score >= 7) return 'a decent choice';
  if (score >= 6) return 'not bad';
  if (score >= 5.5) return 'okay';
  if (score >= 4) return 'better options exist';
  return 'not recommended';
}

const overallScore = parseScore(rating?.overall);
const descriptor = scoreDescriptor(overallScore);
---
{visible.length > 0 && (
  <section class="ratings">
    <h3 class="ratings-title">
      Performance Breakdown
      {descriptor && <span class="ratings-descriptor">{descriptor}</span>}
    </h3>

    <div class="ratings-row" role="list">
      {visible.map(({ key, label, score }) => {
        const s = score as number;
        const hue = Math.round((s / 10) * 120); // 0→120 (red→green)
        const alpha = (0.10 + (s / 10) * 0.22).toFixed(3); // subtle → stronger
        return (
          <div
            class="rating-tile"
            data-key={key}
            role="listitem"
            aria-label={`${label} ${s.toFixed(1)}/10`}
            style={`--h:${hue};`}
          >
            <div class="rating-score">{s.toFixed(1)}</div>
            <div class="rating-label">{label}</div>
          </div>
        );
      })}
    </div>
  </section>
)}
