---
const id = `sim-${Math.random().toString(36).slice(2,8)}`;
const { slug, aspect = "16/9", showPause = true } = Astro.props;
---

<div class="sim-stage centered_flex" style={`aspect-ratio: ${aspect};`} id={`stage-${id}`}>
  <canvas id={id}></canvas>
  {showPause && (
    <button id={`pause-${id}`} class="pill sim-controls-inline" type="button" aria-pressed="false">
      Play
    </button>
  )}
</div>

<script is:inline type="module" define:vars={{ id, slug }}>
  const init = async () => {
    const canvas = document.getElementById(id);
    const pauseBtn = document.getElementById(`pause-${id}`);
    const stage = document.getElementById(`stage-${id}`);
    if (!canvas) return;
    if (canvas.dataset.simInitialized === 'true') return;
    canvas.dataset.simInitialized = 'true';

    // One-time: on the FIRST Play click, reveal the canvas smoothly.
    // Uses {once:true} so your loader keeps owning the button afterwards.
    if (pauseBtn && stage) {
      pauseBtn.addEventListener('click', () => stage.classList.add('is-visible'), { once: true });
    }

    const start = async () => {
      if (canvas.dataset.simStarted === 'true') return;
      canvas.dataset.simStarted = 'true';

      // âœ… dynamic import with a variable path (your existing loader)
      const mod = await import(`/interactive/${slug}/loader.js`);
      await (mod.default || mod)(canvas, pauseBtn);

      // Start playing immediately once it's in view.
      if (pauseBtn) pauseBtn.click();
    };

    // Respect reduced motion: don't autoplay.
    if (window.matchMedia?.('(prefers-reduced-motion: reduce)')?.matches) return;

    if (typeof IntersectionObserver === 'undefined' || !stage) {
      await start();
      return;
    }

    const observer = new IntersectionObserver(
      (entries) => {
        const entry = entries[0];
        if (!entry?.isIntersecting) return;
        observer.disconnect();
        start().catch((err) => console.error('SimCanvas start failed:', err));
      },
      { threshold: 0.25 },
    );
    observer.observe(stage);
  };

  init().catch((err) => console.error('SimCanvas load failed:', err));
  document.addEventListener('astro:page-load', () => {
    init().catch((err) => console.error('SimCanvas load failed:', err));
  });
</script>
