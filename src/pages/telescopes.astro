---
import Layout from '../layouts/Layout.astro';
import '../styles/telescopes.css';
import '../styles/cards.css';

const allPosts = await Astro.glob('./posts/*.{md,mdx}');
const telescopePosts = allPosts.filter(p => p.frontmatter.subcategory === 'telescopes');
const telescopeCount = telescopePosts.length;

// ── CATEGORY ICONS (inline SVG strings; all inherit currentColor) ──
const ICONS: Record<string, string> = {
  all: `
<svg viewBox="0 0 48 48" width="48" height="48" aria-hidden="true" xmlns="http://www.w3.org/2000/svg">
  <g fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    <rect x="6" y="10" width="12" height="8" rx="2"/>
    <rect x="20" y="10" width="22" height="8" rx="2"/>
    <rect x="6" y="26" width="20" height="8" rx="2"/>
    <rect x="28" y="26" width="14" height="8" rx="2"/>
  </g>
</svg>`,

  "Dobsonian": `
<!-- Dobsonian Icon (larger, detailed outline) -->
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 80 80" role="img" aria-label="Dobsonian Telescope">
  <g fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
    <!-- Tube (wider & taller) -->
    <rect x="28" y="10" width="16" height="44" rx="4"/>
    <!-- Open top -->
    <line x1="28" y1="10" x2="44" y2="10"/>
    <!-- Primary mirror cell / back cap -->
    <line x1="28" y1="54" x2="44" y2="54"/>

    <!-- Focuser stub -->
    <rect x="44" y="20" width="6" height="8" rx="1.5"/>

    <!-- Rocker box sides -->
    <path d="M26 54v18h20V54"/>
    <!-- Base semicircle (alt-az base, wider) -->
    <path d="M22 72a20 8 0 0 0 28 0"/>

    <!-- Altitude bearings -->
    <circle cx="28" cy="46" r="3"/>
    <circle cx="44" cy="46" r="3"/>
  </g>
</svg>`,

  "Tabletop Dobsonian": `
<!-- Tabletop Dobsonian Icon (tilted tube, outline) -->
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 80 80" role="img" aria-label="Tabletop Dobsonian Telescope">
  <g fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
    <!-- Tilted optical tube -->
    <rect x="30" y="14" width="22" height="30" rx="4" transform="rotate(-20 30 14)"/>
    <!-- Open front -->
    <line x1="30" y1="14" x2="52" y2="14" transform="rotate(-20 30 14)"/>
    <!-- Back cell -->
    <line x1="30" y1="44" x2="52" y2="44" transform="rotate(-20 30 14)"/>

    <!-- Small focuser stub -->
    <rect x="52" y="22" width="6" height="8" rx="1.5" transform="rotate(-20 52 22)"/>

    <!-- Altitude bearings (rings on tube) -->
    <circle cx="28" cy="36" r="3"/>
    <circle cx="48" cy="36" r="3"/>

    <!-- Low cradle / tabletop mount sides -->
    <path d="M26 44v10h24V44"/>

    <!-- Round tabletop base -->
    <ellipse cx="38" cy="58" rx="18" ry="6"/>
  </g>
</svg>`,

  "Refractor": `
<!-- Refractor Telescope Icon (alt-az mount, outline) -->
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 80 80" role="img" aria-label="Refractor Telescope">
  <g fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
    <!-- Tripod legs -->
    <path d="M40 50l-14 24M40 50l14 24M28 56l-8 18M52 56l8 18"/>
    <!-- Tripod hub -->
    <ellipse cx="40" cy="50" rx="14" ry="5"/>

    <!-- Alt-az mount fork -->
    <path d="M36 34l8 6v10h-8z"/>

    <!-- Long optical tube (tilted) -->
    <rect x="10" y="18" width="44" height="10" rx="3" transform="rotate(15 10 18)"/>
    <!-- Objective lens cell -->
    <ellipse cx="52" cy="26" rx="6" ry="5" transform="rotate(15 52 26)"/>
    <!-- Diagonal / focuser at back -->
    <rect x="8" y="20" width="6" height="6" rx="1" transform="rotate(15 8 20)"/>
    <!-- Small finder stub -->
    <rect x="44" y="20" width="8" height="3" rx="1.5" transform="rotate(15 44 20)"/>
  </g>
</svg>`,

  "Reflector": `
<svg viewBox="0 0 48 48" width="48" height="48" aria-hidden="true" xmlns="http://www.w3.org/2000/svg">
  <g fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    <!-- newtonian tube -->
    <path d="M10 19 l20 -7 l3 7 l-20 7 z"/>
    <!-- secondary spider hint -->
    <path d="M24 18 l3 3"/>
    <!-- eq mount + tripod -->
    <path d="M20 30 l6 -6 l4 2"/>
    <path d="M20 30 l-6 10 M26 24 l2 14 M30 28 l8 10"/>
  </g>
</svg>`,

  "Newtonian Reflector": `
<svg viewBox="0 0 48 48" width="48" height="48" aria-hidden="true" xmlns="http://www.w3.org/2000/svg">
  <g fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    <!-- newtonian tube -->
    <path d="M10 19 l20 -7 l3 7 l-20 7 z"/>
    <!-- secondary spider hint -->
    <path d="M24 18 l3 3"/>
    <!-- eq mount + tripod -->
    <path d="M20 30 l6 -6 l4 2"/>
    <path d="M20 30 l-6 10 M26 24 l2 14 M30 28 l8 10"/>
  </g>
</svg>`,

  "Bird-Jones Reflector": `
<svg viewBox="0 0 48 48" width="48" height="48" aria-hidden="true" xmlns="http://www.w3.org/2000/svg">
  <g fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    <!-- newtonian tube -->
    <path d="M10 19 l20 -7 l3 7 l-20 7 z"/>
    <!-- secondary spider hint -->
    <path d="M24 18 l3 3"/>
    <!-- eq mount + tripod -->
    <path d="M20 30 l6 -6 l4 2"/>
    <path d="M20 30 l-6 10 M26 24 l2 14 M30 28 l8 10"/>
  </g>
</svg>`,

  "Astrograph": `
<!-- Astrograph Icon (outline, wider) -->
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 80 64" role="img" aria-label="Astrograph">
  <g fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    <!-- Rear cell / camera side -->
    <rect x="5" y="22" width="8" height="20" rx="2"/>

    <!-- Primary tube (wider) -->
    <rect x="13" y="18" width="46" height="28" rx="3"/>

    <!-- Focus/locking ring (ribbed band) -->
    <rect x="32" y="17" width="6" height="30" rx="2"/>
    <path d="M35 17v30M32 20h6M32 24h6M32 28h6M32 32h6M32 36h6M32 40h6"/>

    <!-- Front extension (dew shield, wider) -->
    <rect x="59" y="20" width="14" height="24" rx="3"/>

    <!-- Clamp (tube ring) -->
    <path d="M24 18v-2a3 3 0 0 1 3-3h4" />
    <path d="M24 46v2a3 3 0 0 0 3 3h4" />
    <rect x="22" y="18" width="8" height="28" rx="2"/>

    <!-- Mount foot -->
    <path d="M24 46h10v6H24z" />

    <!-- Dovetail / plate (longer) -->
    <rect x="14" y="52" width="50" height="6" rx="2"/>
    <path d="M20 55h8M32 55h8M44 55h8"/>
  </g>
</svg>`,

  "Maksutov-Cassegrain": `
<!-- Simplified SCT / NexStar Icon -->
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 80 80" role="img" aria-label="SCT on fork mount">
  <g fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
    <!-- Tripod legs -->
    <path d="M40 54l-14 20M40 54l14 20M28 58l-8 16M52 58l8 16" />
    <!-- Base -->
    <ellipse cx="40" cy="54" rx="16" ry="6"/>

    <!-- Fork arm -->
    <path d="M46 28v18h-12V28" />

    <!-- Optical tube (tilted) -->
    <rect x="20" y="18" width="28" height="16" rx="3" transform="rotate(20 20 18)"/>
    <!-- Corrector/front ring -->
    <ellipse cx="46" cy="26" rx="6" ry="5" transform="rotate(20 46 26)"/>

    <!-- Finder stub -->
    <rect x="48" y="20" width="6" height="3" rx="1.5" transform="rotate(20 48 20)"/>
  </g>
</svg>`,

  "Schmidt-Cassegrain": `
<svg viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
  <g fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    <!-- tripod -->
    <ellipse cx="24" cy="30" rx="4" ry="2"/>
    <path d="M24 30 v14 M24 44 L14 46 M24 44 L34 46"/>

    <!-- single fork arm + altitude joint -->
    <rect x="26" y="20" width="4" height="10" rx="2"/>
    <circle cx="28" cy="20" r="3"/>

    <!-- optical tube (short, fat) with front corrector ring; tilted slightly up -->
    <g transform="rotate(-15 28 18)">
      <rect x="18" y="14" width="16" height="6" rx="2"/>
      <circle cx="18" cy="17" r="3"/>
    </g>
  </g>
</svg>`,

  "Smart Telescope": `
<svg viewBox="0 0 48 48" width="48" height="48" aria-hidden="true" xmlns="http://www.w3.org/2000/svg">
  <g fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    <!-- upright smart body -->
    <rect x="16" y="10" width="16" height="20" rx="4"/>
    <circle cx="24" cy="18" r="2.5"/>
    <!-- single arm + base -->
    <path d="M28 30 v4 h-8 v-4"/>
    <rect x="14" y="34" width="20" height="4" rx="2"/>
  </g>
</svg>`,

  "Other": `
<svg viewBox="0 0 48 48" width="48" height="48" aria-hidden="true" xmlns="http://www.w3.org/2000/svg">
  <g fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    <path d="M24 8 v8 M24 32 v8 M8 24 h8 M32 24 h8"/>
    <circle cx="24" cy="24" r="6"/>
  </g>
</svg>`
};

// ── SORTED “All” POSTS ──
const sortedAll = [...telescopePosts].sort(
  (a, b) => (b.frontmatter.rating?.overall ?? 0) - (a.frontmatter.rating?.overall ?? 0)
);

// ── GROUP & SORT BY TYPE ──
const grouped = telescopePosts.reduce((acc, post) => {
  const type = post.frontmatter.telescopeType || 'Other';
  (acc[type] ??= []).push(post);
  return acc;
}, {});
const types = Object.keys(grouped).sort();
const sortedGrouped = Object.fromEntries(
  types.map(type => [
    type,
    [...grouped[type]].sort(
      (a, b) => (b.frontmatter.rating?.overall ?? 0) - (a.frontmatter.rating?.overall ?? 0)
    ),
  ])
);
---

<Layout title="Telescope Reviews">
  <div class="telescopes-toggle-container">
    <!-- toggle buttons -->
  <div class="toggle-buttons" role="tablist" aria-label="Telescope categories">
    <button data-type="all" class="icon-button active" role="tab" aria-selected="true">
      <span class="icon" set:html={ICONS.all}></span>
      <span class="label">All</span>
    </button>
    {types.map(t => (
      <button data-type={t} class="icon-button" role="tab" aria-selected="false">
        <span class="icon" set:html={ICONS[t] || ICONS["Other"]}></span>
        <span class="label">{t}</span>
      </button>
    ))}
  </div>

    <!-- description placeholder -->
    <div id="type-description" class="type-description" data-count={telescopeCount}></div>

   <!-- “All” group -->
    <div class="post-group" data-type="all">
      <h2>All Telescopes</h2>
      <div class="post-grid">
        {sortedAll.map(({ frontmatter, url }) => {
          const { title, description, rating, writer, pubDate, affiliate = {} } = frontmatter;
          const cleanTitle = title.replace(/ (Review|Overview)$/, '');
          const score = rating?.overall ?? 'N/A';
          const affs = [
            ['Amazon', affiliate.amazon],
            ['HighPoint', affiliate.highpointscientific],
            ['Astroshop', affiliate.astroshop],
          ].filter(([, link]) => link);

          return (
            <div class="post-card post-card--review">
              <a href={url} class="post-card-link">
                <div class="post-card-title">{cleanTitle}</div>

                {(writer || pubDate) && (
                  <div class="post-card-meta">
                    {writer ? `By ${writer}` : ''}{writer && pubDate ? ' — ' : ''}
                    {pubDate ? new Date(pubDate).toLocaleDateString() : ''}
                  </div>
                )}

                <p class="post-card-desc">{description}</p>

                <div class="post-card-footer has-badge">
                  <div class="post-card-badges">
                    <span class="review-badge">Review</span>
                    <span class="score-badge">{score}/10</span>
                  </div>
                  <div class="read-post">Read the review →</div>
                </div>
              </a>

              {affs.length > 0 && (
                <div class="affiliate-links">
                  {affs.map(([name, link]) => (
                    <a href={link} class="affiliate-btn" target="_blank" rel="noopener">
                      Buy on {name}
                    </a>
                  ))}
                </div>
              )}
            </div>
          );
        })}
      </div>
    </div>

    {/* one group per type */}
    {types.map(type => (
      <div class="post-group" data-type={type} style="display:none;">
        <h2>{type} Telescopes</h2>
        <div class="post-grid">
          {sortedGrouped[type].map(({ frontmatter, url }) => {
            const { title, description, rating, writer, pubDate, affiliate = {} } = frontmatter;
            const cleanTitle = title.replace(/ (Review|Overview)$/, '');
            const score = rating?.overall ?? 'N/A';
            const affs = [
              ['Amazon', affiliate.amazon],
              ['HighPoint', affiliate.highpointscientific],
              ['Astroshop', affiliate.astroshop],
            ].filter(([, link]) => link);

            return (
              <div class="post-card post-card--review">
                <a href={url} class="post-card-link">
                  <div class="post-card-title">{cleanTitle}</div>

                  {(writer || pubDate) && (
                    <div class="post-card-meta">
                      {writer ? `By ${writer}` : ''}{writer && pubDate ? ' — ' : ''}
                      {pubDate ? new Date(pubDate).toLocaleDateString() : ''}
                    </div>
                  )}

                  <p class="post-card-desc">{description}</p>

                  <div class="post-card-footer has-badge">
                    <div class="post-card-badges">
                      <span class="review-badge">Review</span>
                      <span class="score-badge">{score}/10</span>
                    </div>
                    <div class="read-post">Read the review →</div>
                  </div>
                </a>

                {affs.length > 0 && (
                  <div class="affiliate-links">
                    {affs.map(([name, link]) => (
                      <a href={link} class="affiliate-btn" target="_blank" rel="noopener">
                        Buy on {name}
                      </a>
                    ))}
                  </div>
                )}
              </div>
            );
          })}
        </div>
      </div>
    ))}
  </div>

  <div id="type-description" class="type-description" ></div>


  <script type="module" client:load>
    // define everything in here

    const descEl  = document.getElementById('type-description');
    const TELESCOPE_COUNT = Number(descEl.dataset.count);
    const formattedCount = new Intl.NumberFormat().format(TELESCOPE_COUNT);
    
    const typeDescriptions = {
      all: `Browse reviews of ${formattedCount} telescopes—find your perfect match in one place.`,
      Dobsonian: "Dobsonians are large-aperture Newtonian reflectors on simple rocker-box mounts—ideal for sweeping deep-sky views.",
      "Tabletop Dobsonian": "A compact Dobsonian you can set on any table—perfect for quick setup and on-the-go observing.",
      Refractor: "Refractors use precision lenses for crisp, high-contrast views of planets, the Moon, and double stars.",
      Reflector: "Classic Newtonian reflectors with mirrors—great light-gathering at an affordable price.",
      "Maksutov-Cassegrain": "Maksutovs pack long focal lengths into small tubes for sharp planetary and lunar views.",
      "Schmidt-Cassegrain": "Schmidts combine mirrors and lenses in a compact, versatile package for both planets and deep-sky objects.",
      "Smart Telescope": "App-controlled scopes automate alignment and tracking—perfect for hands-free stargazing.",
      Other: "Unique designs and hybrids—explore these if you’re craving something different.",
    };

    const buttons = document.querySelectorAll('.toggle-buttons button');
    const groups  = document.querySelectorAll('.post-group');

    function showGroup(type) {
      // toggle visibility
      groups.forEach(g => {
        g.style.display = type === 'all'
          ? (g.dataset.type === 'all' ? '' : 'none')
          : (g.dataset.type === type ? '' : 'none');
      });
      // update description text
      descEl.textContent = typeDescriptions[type] || '';
    }

    // wire up buttons & initial state
    buttons.forEach(btn =>
      btn.addEventListener('click', () => {
        buttons.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        showGroup(btn.dataset.type);
      })
    );

    // show “all” on first load
    showGroup('all');
  </script>
</Layout>