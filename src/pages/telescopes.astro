---

import Layout from '../layouts/Layout.astro';
import '../styles/telescopes.css';
import '../styles/cards.css';
import { getCollection } from 'astro:content';

const reviewEntries = (await getCollection('reviews')).filter(e => !e.data?.draft);

const telescopeCount = reviewEntries.length;

/* Helper to create /posts/:slug URLs */
const toUrl = (entry: any) => {
  const s =
    entry.slug ??
    entry.id?.toString()?.split('/').pop()?.replace(/\.(md|mdx)$/, '');
  return `/posts/${s}/`;
};

// ── SORTED “All” POSTS ──
const sortedAll = [...reviewEntries].sort(
  (a, b) => (b.data?.rating?.overall ?? 0) - (a.data?.rating?.overall ?? 0)
);

// ── GROUP & SORT BY TYPE ──
const grouped = reviewEntries.reduce((acc, entry) => {
  const type = entry.data?.telescopeType || 'Other';
  (acc[type] ??= []).push(entry);
  return acc;
}, {} as Record<string, typeof reviewEntries>);

const types = Object.keys(grouped).sort();

const sortedGrouped = Object.fromEntries(
  types.map(type => [
    type,
    [...grouped[type]].sort(
      (a, b) => (b.data?.rating?.overall ?? 0) - (a.data?.rating?.overall ?? 0)
    ),
  ])
);

---

<Layout title="Telescope Reviews">
  <h1 class="telescope-rankings-page-title">Telescope Rankings</h1>

  <div class="telescopes-toggle-container">
    <!-- toggle buttons -->
    <div class="toggle-buttons" role="tablist" aria-label="Telescope categories">
      <!-- "All" button -->
      <button data-type="all" class="icon-button active" role="tab" aria-selected="true">
        <svg class="icon" width="28" height="28" aria-hidden="true">
          <use href="/icons/telescope-icons.svg#all"></use>
        </svg>
        <span class="label">All</span>
      </button>

      <!-- Dynamically render buttons for each telescope type -->
      {types.map((t) => {
        const slug = t.toLowerCase().replace(/\s+/g, '-'); // e.g. "Tabletop Dobsonian" → "tabletop-dobsonian"
        return (
          <button data-type={t} class="icon-button" role="tab" aria-selected="false">
            <svg class="icon" width="28" height="28" aria-hidden="true">
              <use href={`/icons/telescope-icons.svg#${slug}`}></use>
            </svg>
            <span class="label">{t}</span>
          </button>
        );
      })}
    </div>

    <!-- description placeholder -->
    <div id="type-description" class="type-description" data-count={telescopeCount}></div>

    <!-- “All” group -->
    <div class="post-group" data-type="all">
      <h2>All Telescopes</h2>
      <div class="post-grid">
        {sortedAll.map((entry) => {
          const data = entry.data ?? {};
          const url = toUrl(entry);

          const cleanTitle = (data.title ?? '').replace(/ (Review|Overview)$/i, '');
          const score = data?.rating?.overall ?? 'N/A';
          const dRaw = data.date ?? data.pubDate;
          const dateStr = dRaw ? new Date(dRaw).toLocaleDateString() : '';

          const affiliate = data.affiliate ?? {};
          const affs: Array<[string, string | undefined]> = [
            ['Amazon', affiliate.amazon],
            ['HighPoint', affiliate.highpointscientific],
            ['Astroshop', affiliate.astroshop],
          ].filter(([, link]) => !!link);

          return (
            <div class="post-card post-card--review">
              <a href={url} class="post-card-link">
                <div class="post-card-title">{cleanTitle}</div>

                {(data.writer || dateStr) && (
                  <div class="post-card-meta">
                    {data.writer ? `By ${data.writer}` : ''}{data.writer && dateStr ? ' — ' : ''}
                    {dateStr}
                  </div>
                )}

                {data.description && <p class="post-card-desc">{data.description}</p>}

                <div class="post-card-footer has-badge">
                  <div class="post-card-badges">
                    <span class="review-badge">Review</span>
                    <span class="score-badge">{score}/10</span>
                  </div>
                  <div class="read-post">Read the review →</div>
                </div>
              </a>

              {affs.length > 0 && (
                <div class="affiliate-links">
                  {affs.map(([name, link]) => (
                    <a href={link!} class="affiliate-btn" target="_blank" rel="noopener">
                      Buy on {name}
                    </a>
                  ))}
                </div>
              )}
            </div>
          );
        })}
      </div>
    </div>

    <!-- one group per type -->
    {types.map((type) => (
      <div class="post-group" data-type={type} style="display:none;">
        <h2>{type} Telescopes</h2>
        <div class="post-grid">
          {sortedGrouped[type].map((entry) => {
            const data = entry.data ?? {};
            const url = toUrl(entry);

            const cleanTitle = (data.title ?? '').replace(/ (Review|Overview)$/i, '');
            const score = data?.rating?.overall ?? 'N/A';
            const dRaw = data.date ?? data.pubDate;
            const dateStr = dRaw ? new Date(dRaw).toLocaleDateString() : '';

            const affiliate = data.affiliate ?? {};
            const affs: Array<[string, string | undefined]> = [
              ['Amazon', affiliate.amazon],
              ['HighPoint', affiliate.highpointscientific],
              ['Astroshop', affiliate.astroshop],
            ].filter(([, link]) => !!link);

            return (
              <div class="post-card post-card--review">
                <a href={url} class="post-card-link">
                  <div class="post-card-title">{cleanTitle}</div>

                  {(data.writer || dateStr) && (
                    <div class="post-card-meta">
                      {data.writer ? `By ${data.writer}` : ''}{data.writer && dateStr ? ' — ' : ''}
                      {dateStr}
                    </div>
                  )}

                  {data.description && <p class="post-card-desc">{data.description}</p>}

                  <div class="post-card-footer has-badge">
                    <div class="post-card-badges">
                      <span class="review-badge">Review</span>
                      <span class="score-badge">{score}/10</span>
                    </div>
                    <div class="read-post">Read the review →</div>
                  </div>
                </a>

                {affs.length > 0 && (
                  <div class="affiliate-links">
                    {affs.map(([name, link]) => (
                      <a href={link!} class="affiliate-btn" target="_blank" rel="noopener">
                        Buy on {name}
                      </a>
                    ))}
                  </div>
                )}
              </div>
            );
          })}
        </div>
      </div>
    ))}
  </div>

  <div id="type-description" class="type-description"></div>

  <script type="module">
    const descEl  = document.getElementById('type-description');
    const TELESCOPE_COUNT = Number(descEl.dataset.count);
    const formattedCount = new Intl.NumberFormat().format(TELESCOPE_COUNT);

    const typeDescriptions = {
      all: `Browse reviews of ${formattedCount} telescopes—find your perfect match in one place.`,
      Dobsonian: "Dobsonians are large-aperture Newtonian reflectors on simple rocker-box mounts—ideal for sweeping deep-sky views.",
      "Tabletop Dobsonian": "A compact Dobsonian you can set on any table—perfect for quick setup and on-the-go observing.",
      Refractor: "Refractors use precision lenses for crisp, high-contrast views of planets, the Moon, and double stars.",
      Reflector: "Classic Newtonian reflectors with mirrors—great light-gathering at an affordable price.",
      "Maksutov-Cassegrain": "Maksutovs pack long focal lengths into small tubes for sharp planetary and lunar views.",
      "Schmidt-Cassegrain": "Schmidts combine mirrors and lenses in a compact, versatile package for both planets and deep-sky objects.",
      "Smart Telescope": "App-controlled scopes automate alignment and tracking—perfect for hands-free stargazing.",
      Other: "Unique designs and hybrids—explore these if you’re craving something different.",
    };

    const buttons = document.querySelectorAll('.toggle-buttons button');
    const groups  = document.querySelectorAll('.post-group');

    function showGroup(type) {
      groups.forEach(g => {
        g.style.display = type === 'all'
          ? (g.dataset.type === 'all' ? '' : 'none')
          : (g.dataset.type === type ? '' : 'none');
      });
      descEl.textContent = typeDescriptions[type] || '';
    }

    buttons.forEach(btn =>
      btn.addEventListener('click', () => {
        buttons.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        showGroup(btn.dataset.type);
      })
    );

    showGroup('all');
  </script>
</Layout>