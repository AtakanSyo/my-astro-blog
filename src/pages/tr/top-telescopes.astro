---
import Layout from '../../layouts/Layout.astro';
import '../../styles/index.css';
import '../../styles/cards.css';
import '../../styles/telescopes.css';
import '../../styles/topTelescopes.css';

const allPosts = await Astro.glob('./posts/*.{md,mdx}', { eager: true });

function normalizeCat(cat) {
  if (!cat) return [];
  if (Array.isArray(cat)) return cat.filter(Boolean).map((c) => String(c).toLowerCase());
  return [String(cat).toLowerCase()];
}

function hasCat(frontmatter, needle) {
  return normalizeCat(frontmatter.category ?? frontmatter.categories).includes(needle);
}

function parseScore(value) {
  if (value === undefined || value === null || value === '') return null;
  if (typeof value === 'number' && Number.isFinite(value)) return Math.max(0, Math.min(10, value));
  const text = String(value).trim().toLowerCase();
  const match = text.match(/^(\d+(?:\.\d+)?)(?:\s*\/\s*(\d+(?:\.\d+)?))?$/);
  if (match) {
    const numerator = parseFloat(match[1]);
    const denominator = match[2] ? parseFloat(match[2]) : 10;
    if (!Number.isNaN(numerator) && !Number.isNaN(denominator) && denominator > 0) {
      return Math.max(0, Math.min(10, (numerator / denominator) * 10));
    }
  }
  const lookup = { a: 9.5, 'a-': 9, 'b+': 8.5, b: 8, 'b-': 7.5, c: 7, 'c-': 6.5 };
  return lookup[text] ?? null;
}

function scoreDescriptor(score) {
  if (score === null) return null;
  if (score >= 9) return 'kozmos seviyesi';
  if (score >= 8) return 'çok güçlü bir tercih';
  if (score >= 7) return 'gayet mantıklı bir seçenek';
  if (score >= 6) return 'fena değil';
  if (score >= 5.5) return 'idare eder';
  if (score >= 4) return 'daha iyi seçenekler var';
  return 'önerilmez';
}

const reviewPosts = allPosts
  .map((post) => {
    const score = parseScore(post.frontmatter?.rating?.overall);
    return { ...post, score };
  })
  .filter((post) => post.score !== null && hasCat(post.frontmatter ?? {}, 'reviews'))
  .sort((a, b) => (b.score ?? 0) - (a.score ?? 0))
  .slice(0, 10);
---

<Layout title="En İyi 10 Teleskop">
  <section class="centered_flex top-ten-section">
    <div class="hero" style="margin-top: 4vh;">
      <span class="hero-kicker">İlk 10 Seçim</span>
      <h1 class="home-title" style="font-size: clamp(2rem, 4vw + 1rem, 4.25rem);">
        Astrosyo'da En Yüksek Puan Alan Teleskoplar
      </h1>
      <p class="home-description" style="max-width: 52ch;">
        İnceleme puanlarımız bu on teleskobu listenin zirvesine taşıdı. Listeyi keşfedin, teknik özellikleri
        karşılaştırın ve bir sonraki gözlem arkadaşınızı bulmak için detaylı incelemelere göz atın.
      </p>
    </div>

    <div class="post-grid top-ten-grid">
      {reviewPosts.map((post, index) => {
        const { frontmatter, score, url } = post;
        const descriptor = scoreDescriptor(score);
        const pubDate = frontmatter.pubDate ? new Date(frontmatter.pubDate).toLocaleDateString() : null;
        const affiliate = frontmatter.affiliate ?? {};
        const affs = [
          ['Amazon', affiliate.amazon],
          ['HighPoint', affiliate.highpointscientific],
          ['Astroshop', affiliate.astroshop],
        ].filter(([, link]) => link);

        const cleanTitle = frontmatter.title
          ? frontmatter.title.replace(/\s+(Review|Overview)$/i, '')
          : 'Untitled Telescope';

        return (
          <div class="post-card post-card--review top-ten-card">
            <a href={url} class="post-card-link">
              <span class="top-ten-rank">#{index + 1}</span>
              <div class="post-card-title">{cleanTitle}</div>
              {frontmatter.description && (
                <p class="post-card-desc">{frontmatter.description}</p>
              )}

              <div class="post-card-footer has-badge">
                <div class="post-card-badges">
                  <span class="review-badge">İnceleme</span>
                  <span class="score-badge">{score?.toFixed(1)}/10</span>
                  {descriptor && <span class="top-ten-chip">{descriptor}</span>}
                  {frontmatter.brand && <span class="top-ten-chip">{frontmatter.brand}</span>}
                  {frontmatter.telescopeType && <span class="top-ten-chip">{frontmatter.telescopeType}</span>}
                </div>
                <div class="read-post">İncelemeyi oku →</div>
              </div>
            </a>

            {affs.length > 0 && (
              <div class="affiliate-links">
                {affs.map(([name, link]) => (
                    <a href={link} class="affiliate-btn" target="_blank" rel="noopener">
                    {name} üzerinde kontrol et
                  </a>
                ))}
              </div>
            )}
          </div>
        );
      })}
    </div>
  </section>
</Layout>

<style>
  .top-ten-section {
    flex-direction: column;
    gap: 2.5rem;
    width: min(900px, 100%);
    padding: 0 1.5rem 4rem;
  }

  .top-ten-grid {
    width: 100%;
    display: grid;
    gap: clamp(18px, 2.4vw, 26px);
    grid-template-columns: 1fr;
  }

  .top-ten-card .post-card-link {
    gap: 0.75rem;
  }

  .top-ten-rank {
    align-self: flex-start;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-width: 2.5rem;
    padding: 0.35rem 0.65rem;
    border-radius: 999px;
    background: rgba(255, 255, 255, 0.08);
    font-weight: 700;
    letter-spacing: 0.04em;
    color: rgba(255, 255, 255, 0.85);
  }

  .top-ten-chip {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    padding: 0.2rem 0.6rem;
    border-radius: 999px;
    background: rgba(255, 255, 255, 0.12);
    font-size: 0.78rem;
    font-weight: 600;
    letter-spacing: 0.05em;
    text-transform: uppercase;
    color: rgba(255, 255, 255, 0.72);
  }

  @media (max-width: 640px) {
    .top-ten-card .post-card-link { gap: 0.65rem; }
    .top-ten-rank { font-size: 0.85rem; padding: 0.3rem 0.6rem; }
    .top-ten-score { font-size: 1.05rem; }
  }
</style>
