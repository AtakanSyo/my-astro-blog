---
// imports stay the same
import Layout from '../../layouts/Layout.astro';
import '../../styles/index.css';
import '../../styles/cards.css';
import '../../styles/search.css';
import '../../styles/category.css';
import '../../styles/simGlobal.css';
import { site } from '../../config/site.js';
import { Instagram, Youtube } from "lucide-react";
import PostCard from "../../components/postCard.astro";
import SpiralGalaxy from "../../components/simulations/spiral-galaxy/SpiralGalaxy.jsx";

// 1) load and sort all posts
const allPosts = Object.values(
  import.meta.glob('./posts/*.{md,mdx}', { eager: true })
) as any[];
allPosts.sort(
  (a, b) => new Date(b.frontmatter.pubDate).getTime() - new Date(a.frontmatter.pubDate).getTime()
);

// helpers
function normalizeCat(cat: unknown): string[] {
  if (!cat) return [];
  if (Array.isArray(cat)) return cat.filter(Boolean).map((c) => String(c).toLowerCase());
  return [String(cat).toLowerCase()];
}
function hasCat(frontmatter: any, needle: string) {
  return normalizeCat(frontmatter.category ?? frontmatter.categories).includes(needle);
}
function latestByCategory(key: string, n = 6) {
  return allPosts.filter(({ frontmatter }) => hasCat(frontmatter, key)).slice(0, n);
}

// category config
const CATS = [
  { key: 'reviews',       label: 'Ä°ncelemeler',               cta: 'Ä°ncelemeyi oku â†’' },
  { key: 'simulation',    label: 'SimÃ¼lasyonlar',             cta: 'SimÃ¼lasyona git â†’' },
  { key: 'informational', label: 'Bilgilendirici YazÄ±lar',    cta: 'Rehberi oku â†’' },
  { key: 'nasa',          label: 'NASA YazÄ±larÄ±',             cta: 'YazÄ±yÄ± gÃ¶r â†’' },
];

const latestNasa = allPosts.find(({ frontmatter }) => hasCat(frontmatter, 'nasa'));
---

<Layout title="Ana Sayfa">
  <section class="centered_flex home-main-section">
    <div class="home-hero-sim">
      <div class="hero-sim-wrap">
        <div class="hero-sim-bg" aria-hidden="true">
          <SpiralGalaxy
            client:load
            showPause={false}
            cameraConfig={{
              position: { x: 0, y: 18, z: 24 },
              lookAt: { x: 0, y: 0, z: 0 },
            }}
          />
        </div>

        <section class="hero centered_flex fade-up">
          <span class="hero-kicker">{site.name}</span>
          <h1 class="home-title">YÄ±ldÄ±zlar iÃ§in rehberin.</h1>
          <p class="home-description">SimÃ¼lasyonlar, kozmik sayfalar ve teleskop incelemeleri.</p>
        </section>

	        <a class="home-sim-link" href="/tr/posts/spiral-galaxies">
	          Ã–ne Ã§Ä±kan simÃ¼lasyona git <span class="home-sim-arrow" aria-hidden="true">â†’</span>
	        </a>
      </div>

      <!-- CTA ROW -->
      <div class="cta-row">
        <a href="/tr/telescopes" class="cta cta-blue" onclick="umami?.track?.('explore-telescopes-cta-tr')">
          <span class="cta-label">ğŸª TeleskoplarÄ± KeÅŸfet</span>
          <span class="cta-arrow">â†’</span>
        </a>

        <a href="/tr/top-telescopes" class="cta cta-amber" onclick="umami?.track?.('top-ten-cta-tr')">
          <span class="cta-label">â­ En Ä°yi 10 Teleskop</span>
          <span class="cta-arrow">â†’</span>
        </a>

        <a href="/tr/category/simulation" class="cta cta-magenta" onclick="umami?.track?.('simulation-category-cta-tr')">
          <span class="cta-label">ğŸŒ€ SimÃ¼lasyonlar</span>
          <span class="cta-arrow">â†’</span>
        </a>

        <a href="/tr/about" class="cta cta-cyan" onclick="umami?.track?.('about-cta-tr')">
          <span class="cta-label">â„¹ï¸ HakkÄ±mÄ±zda</span>
          <span class="cta-arrow">â†’</span>
        </a>
      </div>

      <!-- SOCIALS -->
      <div class="global-socials">
        <div class="global-socials-links">
          <a href="https://www.instagram.com/astrosyo_" target="_blank" rel="noopener noreferrer" class="social-link" aria-label="Instagram">
            <Instagram size={36} />
          </a>

          <a href="https://www.youtube.com/@atakansaracyakupoglu9930" target="_blank" rel="noopener noreferrer" class="social-link" aria-label="YouTube">
            <Youtube size={36} />
          </a>

          <a href="https://www.tiktok.com/@astrosyo?_r=1&_t=ZS-917RKCaEM" target="_blank" rel="noopener noreferrer" class="social-link" aria-label="TikTok">
            <svg width="36" height="36" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
              <path d="M14.25 4.5c.45.87 1.23 1.59 2.19 2.04.46.22.97.35 1.48.38V9.4c-1.17-.05-2.3-.43-3.3-1.08v5.47c0 3.02-2.45 5.46-5.47 5.46S3.68 16.81 3.68 13.79c0-2.51 1.71-4.65 4.12-5.24.66-.16 1.34-.16 1.99-.04v2.51a2.7 2.7 0 0 0-.99-.19c-1.5 0-2.72 1.22-2.72 2.72s1.22 2.72 2.72 2.72 2.72-1.22 2.72-2.72V3h3.01c.08.52.26 1.02.52 1.5z" />
            </svg>
          </a>
        </div>
      </div>
    </div>

    <!-- Kategoriye gÃ¶re en son yazÄ±lar -->
    <section class="latest-section">
      {CATS.map((cat) => {
        const items = latestByCategory(cat.key, 4);
        if (items.length === 0) return null;

        return (
          <section class="category-section">
            <h2>
              <a href={`/tr/category/${cat.key.toLowerCase()}`} class="latest-title">
                {cat.label} â†’
              </a>
            </h2>

            <div class="post-grid">
              {
                items.map(({ frontmatter, url }) => {
                  const isP5     = hasCat(frontmatter, 'simulation');
                  const isReview = hasCat(frontmatter, 'reviews');
                  const isInfo   = hasCat(frontmatter, 'informational');
                  const isNasa   = hasCat(frontmatter, 'nasa');

                  const ctaText =
                    isP5 ? 'SimÃ¼lasyona git â†’'
                  : isReview ? 'Ä°ncelemeyi oku â†’'
                  : isInfo ? 'Rehberi oku â†’'
                  : isNasa ? 'YazÄ±yÄ± gÃ¶r â†’'
                  : 'YazÄ±nÄ±n tamamÄ±nÄ± oku â†’';

                  return (
                    <PostCard
                      url={url}
                      frontmatter={frontmatter}
                      isP5={isP5}
                      isReview={isReview}
                      isInfo={isInfo}
                      isNasa={isNasa}
                      ctaText={ctaText}
                    />
                  );
                })
              }
            </div>
            <span class="divider"></span>
          </section>
        );
      })}
    </section>
  </section>
</Layout>
