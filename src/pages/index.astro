---
// imports stay the same
import Layout from '../layouts/Layout.astro';
import '../styles/index.css';
import '../styles/cards.css';
import '../styles/search.css';
import { site } from '../config/site.js';
import { Instagram, Youtube } from "lucide-react";
import fs from 'fs/promises';

// 1) load and sort all posts
const allPosts = await Astro.glob('./posts/*.{md,mdx}', { eager: true });
allPosts.sort((a, b) => new Date(b.frontmatter.pubDate) - new Date(a.frontmatter.pubDate));

// helpers
function normalizeCat(cat) {
  if (!cat) return [];
  if (Array.isArray(cat)) return cat.filter(Boolean).map((c) => String(c).toLowerCase());
  return [String(cat).toLowerCase()];
}
function hasCat(frontmatter, needle) {
  return normalizeCat(frontmatter.category ?? frontmatter.categories).includes(needle);
}
function latestByCategory(key, n = 4) {
  return allPosts.filter(({ frontmatter }) => hasCat(frontmatter, key)).slice(0, n);
}

// category config
const CATS = [
  { key: 'nasa',          label: 'NASA',           cta: 'See the article ‚Üí' },
  { key: 'reviews',        label: 'Reviews',        cta: 'Read the review ‚Üí' },
  { key: 'simulation',    label: 'Simulation',    cta: 'Go to the simulation ‚Üí' },
  { key: 'informational', label: 'Informational',         cta: 'Read the guide ‚Üí' },
];

const latestNasa = allPosts.find(({ frontmatter }) => hasCat(frontmatter, 'nasa'));

function descriptorFromScore(score) {
  if (score === null || Number.isNaN(score)) return null;
  if (score >= 9) return 'cosmic';
  if (score >= 8) return 'strong pick';
  if (score >= 7) return 'a decent choice';
  if (score >= 6) return 'not bad';
  if (score >= 5.5) return 'okay';
  if (score >= 4) return 'better options exist';
  return 'not recommended';
}

let histogramData = null;

try {
  const csvUrl = new URL('../../ratings.csv', import.meta.url);
  const csvText = await fs.readFile(csvUrl, 'utf-8');
  const lines = csvText.trim().split(/\r?\n/);
  if (lines.length > 1) {
    const headers = lines[0].split(',');
    const overallIdx = headers.indexOf('overall');
    if (overallIdx !== -1) {
      const scores = lines
        .slice(1)
        .map((line) => {
          const columns = line.split(',');
          const value = parseFloat(columns[overallIdx]);
          return Number.isFinite(value) ? value : null;
        })
        .filter((value) => value !== null);

      if (scores.length > 0) {
        const bins = [
          { label: '0‚Äì4', min: 0, max: 4 },
          { label: '4‚Äì5.5', min: 4, max: 5.5 },
          { label: '5.5‚Äì6', min: 5.5, max: 6 },
          { label: '6‚Äì7', min: 6, max: 7 },
          { label: '7‚Äì8', min: 7, max: 8 },
          { label: '8‚Äì9', min: 8, max: 9 },
          { label: '9‚Äì10', min: 9, max: 10.0001 },
        ];

        const counts = bins.map((bin, index) =>
          scores.filter((score) => score >= bin.min && (index === bins.length - 1 ? score <= bin.max : score < bin.max)).length
        );

        const descriptorOrder = ['cosmic', 'strong pick', 'a decent choice', 'not bad', 'okay', 'better options exist', 'not recommended'];
        const descriptorCounts = descriptorOrder.map((label) => ({
          label,
          count: scores.filter((score) => descriptorFromScore(score) === label).length,
        }));

        const avgScore = scores.reduce((sum, value) => sum + value, 0) / scores.length;
        const topDescriptor = descriptorCounts.reduce((best, current) => (current.count > best.count ? current : best), descriptorCounts[0] ?? { label: '', count: 0 });
        const lowDescriptor = descriptorCounts.find((item) => item.label === 'not recommended') ?? { label: 'not recommended', count: 0 };

        const chartWidth = 560;
        const chartHeight = 260;
        const margin = { top: 28, right: 32, bottom: 52, left: 48 };
        const plotWidth = chartWidth - margin.left - margin.right;
        const plotHeight = chartHeight - margin.top - margin.bottom;
        const barSlot = plotWidth / bins.length;
        const barWidth = Math.min(70, barSlot * 0.65);
        const maxCount = Math.max(...counts);

        histogramData = {
          bins,
          counts,
          scores,
          descriptorCounts,
          average: avgScore,
          total: scores.length,
          summary: `Average overall score sits at ${avgScore.toFixed(2)} across ${scores.length} recent reviews.`,
          distribution: descriptorCounts.map(({ label, count }) => `${label}: ${count}`).join(' ¬∑ '),
          insight: `${topDescriptor.count} review${topDescriptor.count === 1 ? '' : 's'} land in the ‚Äú${topDescriptor.label}‚Äù tier, while only ${lowDescriptor.count} ${lowDescriptor.count === 1 ? 'falls' : 'fall'} into ‚Äú${lowDescriptor.label}.‚Äù`,
          chart: {
            width: chartWidth,
            height: chartHeight,
            margin,
            plotWidth,
            plotHeight,
            barSlot,
            barWidth,
            maxCount,
          },
        };
      }
    }
  }
} catch (error) {
  histogramData = null;
}

---

<Layout title="Home">
  <section class="centered_flex home-main-section">
    <section class="hero">
      <span class="hero-kicker">{site.name}</span>
      <h1 class="home-title">{site.description}</h1>
      <p class="home-description">Simulations, cosmic insights, and telescope reviews.</p>

      <div class="cta-row">
        <a href="/telescopes" class="cta cta--primary" onclick="umami?.track?.('explore-telescopes-cta')">ü™ê Explore Telescopes</a>
        <a href="/top-telescopes" class="cta cta--dark" onclick="umami?.track?.('top-ten-cta')">‚≠ê Top 10 Picks</a>
        <a href="/about" class="cta cta--ghost" onclick="umami?.track?.('about-cta')">‚ÑπÔ∏è About Us</a>
      </div>

      <div class="home-socials">
        <div class="home-socials-links">
          <a href="https://www.instagram.com/astrosyo_" target="_blank" rel="noopener noreferrer" class="social-link" aria-label="Instagram">
            <Instagram size={42} />
          </a>
          <a href="https://www.youtube.com/@atakansaracyakupoglu9930" target="_blank" rel="noopener noreferrer" class="social-link" aria-label="YouTube">
            <Youtube size={42} />
          </a>
        </div>
      </div>
    </section>

    <!-- Latest by category (stacked sections) -->
    <section class="latest-section">
      {CATS.map((cat) => {
        const items = latestByCategory(cat.key, 4);
        if (items.length === 0) return null;

        return (
          <section class="category-section">

            <a href={`/category/${cat.label.toLowerCase()}`} class="latest-link">
              <h2 class="latest-title">{cat.label} ‚Üí</h2>
            </a>

            <div class="post-grid category-grid">
              {
                items.map(({ frontmatter, url }) => {
                  const isP5     = hasCat(frontmatter, 'simulation');
                  const isReview = hasCat(frontmatter, 'reviews');
                  const isInfo   = hasCat(frontmatter, 'informational');
                  const isNasa   = hasCat(frontmatter, 'nasa');
                  const isLatestNasa = isNasa && latestNasa && url === latestNasa.url;

                  const cardClasses = [
                    'post-card',
                    isP5 && 'post-card--p5',
                    isReview && 'post-card--review',
                    isInfo && 'post-card--info',
                    isNasa && 'post-card--nasa',
                  ].filter(Boolean).join(' ');

                  const ctaText =
                    isP5 ? 'Go to the simulation ‚Üí'
                  : isReview ? 'Read the review ‚Üí'
                  : isInfo ? 'Read the guide ‚Üí'
                  : isNasa ? 'See the article ‚Üí'
                  : 'Read full post ‚Üí';

                  return (
                    <div class={cardClasses}>
                      <a href={url} class="post-card-link">
                        <div class="post-card-title">{frontmatter.title}</div>
                        <div class="post-card-meta">
                          By {frontmatter.writer} ‚Äî {new Date(frontmatter.pubDate).toLocaleDateString()}
                        </div>
                        <p class="post-card-desc">{frontmatter.description}</p>

                        <div class={`post-card-footer ${(isP5 || isReview || isInfo || isNasa) ? 'has-badge' : ''}`}>
                          <div class="post-card-badges">
                            {isP5 && <span class="p5-badge">Simulation</span>}
                            {isReview && <span class="review-badge">Review</span>}
                            {isInfo && <span class="info-badge">Info</span>}
                            {isNasa && <span class="nasa-badge">NASA</span>}
                          </div>
                          <div class="read-post">{ctaText}</div>
                        </div>
                      </a>
                    </div>
                  );
                })
              }
            </div>
          </section>
        );
      })}
    </section>

    <!-- Your existing notices (unchanged) -->
    <section class="home-notice home-notice-first">
      <h3 class="home-notice-title">Why trust us?</h3>
      <p class="home-notice-text">
        Astrosyo is an astronomy blog created by experts in software and astronomy.
        Our writers <strong>Atakan Sara√ßyakupoƒülu</strong> and <strong>Zane Landers</strong>
        provide trustworthy product insights, overviews, and reviews to help you with your stargazing adventures.
      </p>
    </section>

    <section class="home-notice">
      <h3 class="home-notice-title">Our Content Types</h3>
      <p class="home-notice-text">
        <strong>Review Posts</strong> are based on hands-on experience and direct testing of telescopes and astronomy gear.
        <strong>Overview Posts</strong> are based on in-depth research, manufacturer data, astronomy community feedback,
        and independent testing data from trusted sources. Both types aim to give you clear, honest, and useful information.
      </p>
    </section>

    <section class="home-notice">
      <h3 class="home-notice-title">Our Rating System</h3>
      <p class="home-notice-text">
        For review posts, our ratings are based on first-hand use and expert judgment.
        For overview posts, our ratings reflect aggregated insights from reputable sources and verified user experiences.
      </p>
    </section>

    <section class="home-notice">
      <h3 class="home-notice-title">Where to buy?</h3>
      <p class="home-notice-text">
        Consider choosing HighPointScientific as your main vendor for shipping safety and refunds.
        Amazon is viable, but has occasionally shipped astronomy gear with missing pieces and more complex refund processes.
      </p>
    </section>

    <section class="home-notice">
      <h3 class="home-notice-title">Affiliate Notice</h3>
      <p class="home-notice-text">
        We have affiliate programs with Amazon, HighPointScientific, and Astroshop.
        If you click on a link and make a purchase, we receive a small commission.
        Our content remains unbiased ‚Äî your satisfaction matters more than short-term affiliate income.
      </p>
    </section>
  </section>
</Layout>
