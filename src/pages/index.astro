---
import Layout from '../layouts/Layout.astro';
import '../styles/index.css';
import '../styles/cards.css';
import '../styles/search.css';
import { site } from '../config/site.js';
import { Instagram, Youtube } from "lucide-react";
import { getCollection } from "astro:content";

type CatKey = 'reviews' | 'nasa' | 'tools' | 'simulations' | 'informational';

const [reviews, nasa, tools, simulations, informational] = await Promise.all([
  getCollection("reviews"),
  getCollection("nasa"),
  getCollection("tools"),
  getCollection("simulations"),
  getCollection("informational"),
]);

const allEntries = [...reviews, ...nasa, ...tools, ...simulations, ...informational]
  .filter(e => !e.data.draft)
  .sort((a, b) => +new Date(b.data.date) - +new Date(a.data.date));

function latestByCollection(key: CatKey, n = 4) {
  return allEntries.filter(e => e.collection === key).slice(0, n);
}
const latestNasa = allEntries.find(e => e.collection === "nasa");
const CATS = [
  { key: 'nasa',           label: 'NASA',           cta: 'See the article ‚Üí' },
  { key: 'reviews',        label: 'Reviews',        cta: 'Read the review ‚Üí' },
  { key: 'simulations',    label: 'Simulations',    cta: 'Go to the simulation ‚Üí' },
  { key: 'informational',  label: 'Informational',  cta: 'Read the guide ‚Üí' },
  { key: 'tools',          label: 'Tools',          cta: 'Use the tool ‚Üí' },
] as const;

const toUrl = (slug: string) => `/posts/${slug}/`;
---

<Layout title="Home">
  <!-- hero unchanged -->
  <section class="centered_flex home-main-section">
    <section class="hero">
      <span class="hero-kicker">{site.name}</span>
      <h1 class="home-title">{site.description}</h1>
      <p class="home-description">Simulations, cosmic insights, and telescope reviews.</p>

      <div class="cta-row">
        <a href="/telescopes" class="cta cta--primary" onclick="umami?.track?.('explore-telescopes-cta')">ü™ê Explore Telescopes</a>
        <a href="/about" class="cta cta--ghost" onclick="umami?.track?.('about-cta')">‚ÑπÔ∏è About Us</a>
      </div>

      <div class="home-socials">
        <div class="home-socials-links">
          <a href="https://www.instagram.com/astrosyo_" target="_blank" rel="noopener noreferrer" class="social-link" aria-label="Instagram">
            <Instagram size={42} />
          </a>
          <a href="https://www.youtube.com/@atakansaracyakupoglu9930" target="_blank" rel="noopener noreferrer" class="social-link" aria-label="YouTube">
            <Youtube size={42} />
          </a>
        </div>
      </div>
    </section>

    <section class="latest-section">
      {
        CATS.map((cat) => {
          const items = latestByCollection(cat.key, 4);
          if (items.length === 0) return null;

          return (
            <section class="category-section">
              <a href={`/category/${cat.label.toLowerCase()}`} class="latest-link">
                <h2 class="latest-title">{cat.label} ‚Üí</h2>
              </a>

              <div class="post-grid category-grid">
                {items.map((entry) => {
                  const data = entry.data;
                  const s = (entry as any).slug
                    ?? (entry as any).id?.toString()?.split('/').pop()?.replace(/\.(md|mdx)$/, '');
                  const url = toUrl(s);

                  const isSim    = entry.collection === 'simulations';
                  const isReview = entry.collection === 'reviews';
                  const isInfo   = entry.collection === 'informational';
                  const isNasa   = entry.collection === 'nasa';
                  const isTool   = entry.collection === 'tools';

                  const cardClasses = [
                    'post-card',
                    isSim && 'post-card--p5',
                    isReview && 'post-card--review',
                    isInfo && 'post-card--info',
                    isNasa && 'post-card--nasa',
                    isTool && 'post-card--info',
                  ].filter(Boolean).join(' ');

                  const ctaText =
                    isSim ? 'Go to the simulation ‚Üí' :
                    isReview ? 'Read the review ‚Üí' :
                    isInfo ? 'Read the guide ‚Üí' :
                    isNasa ? 'See the article ‚Üí' :
                    isTool ? 'Use the tool ‚Üí' :
                    'Read full post ‚Üí';

                  return (
                    <div class={cardClasses}>
                      <a href={url} class="post-card-link">
                        <div class="post-card-title">{data.title}</div>
                        <div class="post-card-meta">
                          {data.writer ? <>By {data.writer} ‚Äî </> : null}
                          {new Date(data.date).toLocaleDateString()}
                        </div>
                        {data.description && <p class="post-card-desc">{data.description}</p>}

                        <div class={`post-card-footer ${ (isSim||isReview||isInfo||isNasa||isTool) ? 'has-badge' : ''}`}>
                          <div class="post-card-badges">
                            {isSim && <span class="p5-badge">Simulation</span>}
                            {isReview && <span class="review-badge">Review</span>}
                            {isInfo && <span class="info-badge">Info</span>}
                            {isNasa && <span class="nasa-badge">NASA</span>}
                            {isTool && <span class="info-badge">Tools</span>}
                          </div>
                          <div class="read-post">{ctaText}</div>
                        </div>
                      </a>
                    </div>
                  );
                })}
              </div>
            </section>
          );
        })
      }
    </section>

    <!-- notices unchanged -->
  </section>
</Layout>