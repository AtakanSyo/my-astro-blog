---
import Layout from '../../layouts/Layout.astro';
import '../../styles/index.css';
import '../../styles/cards.css';
import '../../styles/category.css';
import FloatingTelescopeIcons from "../../components/FloatingTelescopeIcons.astro";
import { getCollection } from "astro:content";

/** Build-time paths kept inside the function to avoid scope issues in dev */
export async function getStaticPaths() {
  const slugs = ["reviews","nasa","tools","simulations","simulation","informational"];
  return slugs.map((slug) => ({ params: { slug } }));
}

type CatKey = 'reviews' | 'nasa' | 'tools' | 'simulations' | 'informational';
const ALLOWED: ReadonlyArray<CatKey> = ['reviews','nasa','tools','simulations','informational'] as const;

/** Normalize & validate slug */
const rawSlug = (Astro.params.slug || '').toString().toLowerCase();
const slug = (rawSlug === "simulation" ? "simulations" : rawSlug) as CatKey;
if (!ALLOWED.includes(slug)) {
  return Astro.redirect('/404');
}

/** Labels */
const labelMap: Record<CatKey, string> = {
  reviews: 'Telescope & Gear Reviews',
  nasa: 'NASA Articles',
  informational: 'Astronomy Guides & Insights',
  simulations: 'Astrophysics Simulations',
  tools: 'Astronomy Tools',
};
const categoryLabel = labelMap[slug];

/** Load collection */
let posts = await getCollection(slug);
posts = posts
  .filter(e => !e.data.draft)
  .sort((a, b) => +new Date(b.data.date) - +new Date(a.data.date));

const toUrl = (s: string) => `/posts/${s}/`;
---

<Layout title="Category">
  {slug === "reviews" && <FloatingTelescopeIcons file="telescope-icons" />}
  {slug === "nasa" && <FloatingTelescopeIcons file="nasa-icons" />}
  {slug === "simulations" && <FloatingTelescopeIcons file="simulation-icons" />}
  {slug === "informational" && <FloatingTelescopeIcons file="informational-icons" />}
  {slug === "tools" && <FloatingTelescopeIcons file="tools-icons" />}

  <h1 class="category-title">{categoryLabel}</h1>

  <div class="post-grid category-grid">
    {posts.length === 0 ? (
      <p>No posts.</p>
    ) : (
      posts.map((entry) => {

        const data = entry.data;
        const s = (entry as any).slug
          ?? (entry as any).id?.toString()?.split('/').pop()?.replace(/\.(md|mdx)$/, '');
        const url = toUrl(s);

        const cardClasses = [
          'post-card',
          entry.collection === 'simulations'   && 'post-card--p5',
          entry.collection === 'reviews'       && 'post-card--review',
          entry.collection === 'informational' && 'post-card--info',
          entry.collection === 'nasa'          && 'post-card--nasa',
          entry.collection === 'tools'         && 'post-card--info',
        ].filter(Boolean).join(' ');

        const ctaText =
          entry.collection === 'simulations'   ? 'Go to the simulation →' :
          entry.collection === 'reviews'       ? 'Read the review →' :
          entry.collection === 'informational' ? 'Read the guide →' :
          entry.collection === 'nasa'          ? 'See the article →' :
          entry.collection === 'tools'         ? 'Use the tool →' :
                                                 'Read full post →';

        return (
          <div class={cardClasses}>
            <a href={url} class="post-card-link">
              <div class="post-card-title">{data.title}</div>
              <div class="post-card-meta">
                {data.writer ? <>By {data.writer} — </> : null}
                {new Date(data.date).toLocaleDateString()}
              </div>
              {data.description && <p class="post-card-desc">{data.description}</p>}

              <div class="post-card-footer has-badge">
                <div class="post-card-badges">
                  {entry.collection === 'simulations'   && <span class="p5-badge">Simulation</span>}
                  {entry.collection === 'reviews'       && <span class="review-badge">Review</span>}
                  {entry.collection === 'informational' && <span class="info-badge">Info</span>}
                  {entry.collection === 'nasa'          && <span class="nasa-badge">NASA</span>}
                  {entry.collection === 'tools'         && <span class="info-badge">Tools</span>}
                </div>
                <div class="read-post">{ctaText}</div>
              </div>
            </a>
          </div>
        );
      })
    )}
  </div>
</Layout>